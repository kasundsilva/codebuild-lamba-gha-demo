# ./.github/workflows/build-deploy.yml

name: deploy

  # https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions
on:
# run on merge to main branch
  push:
    branches: [ "main" ]

  # manual trigger from GitHub UI
  # https://docs.github.com/en/actions/managing-workflow-runs/manually-running-a-workflow
  workflow_dispatch:

jobs:
  build:
    # use the build workflow from the current repository
    # https://docs.github.com/en/actions/learn-github-actions/reusing-workflows#calling-a-reusable-workflow
    uses: ./.github/workflows/build.yml
    # that's all - jobs that call a reusable workflow can do nothing else

  deploy:
    # only run the 'deploy' job if the 'use-build' job passes
    # https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#jobsjob_idneeds
    needs: build

    runs-on:
        - codebuild-codebuild-meets-gha-${{ github.run_id }}-${{ github.run_attempt }}

    # https://docs.github.com/en/actions/learn-github-actions/workflow-syntax-for-github-actions#jobsjob_idsteps
    steps:
      - name: Download build artifact
        # https://github.com/actions/download-artifact
        uses: actions/download-artifact@v4
        with:
          # the same name as used in the build workflow
          name: build-artifact
          # where to save the artifact
          # using the same path as in the build workflow "restores" the state from the end of the build workflow
          path: build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-2

      - name: Deploy to S3
        run: |
          aws s3 sync build/ s3://${{ secrets.DEPLOY_AWS_S3_BUCKET }} \
            --acl public-read \
            --follow-symlinks \
            --delete
